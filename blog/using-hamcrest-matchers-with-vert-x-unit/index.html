<!DOCTYPE html><html lang=en><head><title>Using Hamcrest Matchers with Vert.x Unit</title><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta content="width=device-width,initial-scale=1" name=viewport><meta content="Vert.x is a tool-kit for building reactive applications on the JVM." name=description><link href=http://vertx.io/stylesheets/main.css media=screen rel=stylesheet><link href=http://vertx.io/stylesheets/font-awesome.min.css media=screen rel=stylesheet><link href=http://vertx.io/javascripts/styles/rainbow.min.css media=screen rel=stylesheet><!--[if lt IE 9]><script src="http://static.jboss.org/theme/js/libs/html5/pre3.6/html5.min.js"></script><![endif]--><link href=http://vertx.io/assets/favicons/vertx-favicon-5.ico rel="shortcut icon"><link href="http://fonts.googleapis.com/css?family=Ubuntu:400,500,700,400italic" rel=stylesheet type=text/css><link rel=alternate type=application/rss+xml title=RSS href=http://vertx.io/feed.xml><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-30144458-1', 'auto');
    ga('create', 'UA-71153120-1', 'auto', 'tracker');
    ga('send', 'pageview');
    ga('tracker.send', 'pageview');</script></head><body><a href="http://www.reactivemanifesto.org/" id=reactive-manifesto-banner><img style="border: 0; position: fixed; right: 0; top:0; z-index: 9000" src=http://d379ifj7s9wntv.cloudfront.net/reactivemanifesto/images/ribbons/we-are-reactive-black-right.png></a> <a id=skippy class="sr-only sr-only-focusable" href=#content><div class=container><span class=skiplink-text>Skip to main content</span></div></a><header class="navbar navbar-default navbar-static-top" id=top role=banner><div class=container><div class=navbar-header><button class="navbar-toggle collapsed" type=button data-toggle=collapse data-target=#vertx-navbar-collapse><span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span></button> <a href="http://vertx.io/" class=navbar-brand><img alt=Brand src=http://vertx.io/assets/logo-sm.png></a></div><nav class="collapse navbar-collapse" id=vertx-navbar-collapse><ul class="nav navbar-nav navbar-right"><li><a href="http://vertx.io/download/">Download</a></li><li><a href="http://vertx.io/docs/">Documentation</a></li><li><a href=https://github.com/vert-x3/wiki/wiki>Wiki</a></li><li><a href="http://vertx.io/community/">Community</a></li><li><a href="http://vertx.io/blog/">Blog</a></li><li><a href="http://vertx.io/vertx2/" class=vertx-2-link>Vert.x 2</a></li></ul></nav></div></header><div class=container><div class="row blog"><article class="col-xs-12 blog-post"><h2 class=blog-post-title>Using Hamcrest Matchers with Vert.x Unit</h2><p class=blog-post-meta>18th January 2016 by <a href=http://github.com/cescoffier>cescoffier</a></p><article><p>Vert.x Unit is a very elegant library to test asynchronous applications developed with vert.x. However because of this asynchronous aspect, reporting test failures is not natural for JUnit users. This is because, the failed assertions need to be reported to the <em>test context</em>, controlling the execution (and so the outcome) of the test. In other words, in a Vert.x Unit test you cannot use the regular Junit assertions and assertion libraries. In this blog post, we propose a way to let you using Hamcrest matchers in Vert.x Unit tests.</p><h2 id=using-vert-x-unit>Using Vert.x Unit</h2><p>Vert.x Unit is a test library made to ensure the behavior of vert.x applications. It lets you implement tests checking asynchronous behavior.</p><p>Vert.x Unit can be used with Junit. For this, you just need to add the following dependency to your project:</p><pre><code class="hljs xml"><span class=hljs-tag>&lt;<span class=hljs-title>dependency</span>&gt;</span>
  <span class=hljs-tag>&lt;<span class=hljs-title>groupId</span>&gt;</span>io.vertx<span class=hljs-tag>&lt;/<span class=hljs-title>groupId</span>&gt;</span>
  <span class=hljs-tag>&lt;<span class=hljs-title>artifactId</span>&gt;</span>vertx-unit<span class=hljs-tag>&lt;/<span class=hljs-title>artifactId</span>&gt;</span>
  <span class=hljs-tag>&lt;<span class=hljs-title>version</span>&gt;</span>3.2.0<span class=hljs-tag>&lt;/<span class=hljs-title>version</span>&gt;</span>
  <span class=hljs-tag>&lt;<span class=hljs-title>scope</span>&gt;</span>test<span class=hljs-tag>&lt;/<span class=hljs-title>scope</span>&gt;</span>
<span class=hljs-tag>&lt;/<span class=hljs-title>dependency</span>&gt;</span></code></pre><p>If you are using Gradle, the dependency is:</p><pre><code class=hljs><span class=hljs-tag>testCompile</span> ‘<span class=hljs-tag>io</span><span class=hljs-class>.vertx</span><span class=hljs-pseudo>:vertx-unit</span><span class=hljs-pseudo>:3</span><span class=hljs-class>.2</span><span class=hljs-class>.0</span>’</code></pre><p>If you are using an IDE, just add the vertx-unit jar to your project classpath.</p><p>Obviously, you would need to add JUnit too.</p><p>Notice that vertx-unit does not need JUnit, and can be used without it. Check the Vert.x Unit <a href="http://vertx.io/docs/vertx-unit/java/">documentation</a> for more details.</p><h2 id=vert-x-unit-example>Vert.x Unit example</h2><p>Let’s consider this very simple <code>Verticle</code>:</p><pre><code class="hljs java"><span class=hljs-keyword>public</span> <span class=hljs-class><span class=hljs-keyword>class</span> <span class=hljs-title>MyFirstVerticle</span> <span class=hljs-keyword>extends</span> <span class=hljs-title>AbstractVerticle</span> </span>{

  <span class=hljs-annotation>@Override</span>
  <span class=hljs-function><span class=hljs-keyword>public</span> <span class=hljs-keyword>void</span> <span class=hljs-title>start</span><span class=hljs-params>(<span class=hljs-keyword>final</span> Future future)</span> <span class=hljs-keyword>throws</span> Exception </span>{
    vertx.createHttpServer()
        .requestHandler(req -&gt; req.response().end(<span class=hljs-string>"hello vert.x"</span>))
        .listen(<span class=hljs-number>8080</span>, done -&gt; {
          <span class=hljs-keyword>if</span> (done.failed()) {
            future.fail(done.cause());
          } <span class=hljs-keyword>else</span> {
            future.complete();
          }
        });
  }
}</code></pre><p>It just creates a new HTTP server and when launched it notifies the <code>future</code> of the completion.</p><p>To test this verticle with Vert.x Unit you would write something like:</p><pre><code class="hljs java"><span class=hljs-annotation>@RunWith</span>(VertxUnitRunner.class)
<span class=hljs-keyword>public</span> <span class=hljs-class><span class=hljs-keyword>class</span> <span class=hljs-title>MyFirstVerticleTest</span> </span>{

  <span class=hljs-keyword>private</span> Vertx vertx;

  <span class=hljs-annotation>@Before</span>
  <span class=hljs-function><span class=hljs-keyword>public</span> <span class=hljs-keyword>void</span> <span class=hljs-title>setUp</span><span class=hljs-params>(TestContext context)</span> </span>{
    vertx = Vertx.vertx();
    vertx.deployVerticle(MyFirstVerticle.class.getName(),
      context.asyncAssertSuccess());
  }

  <span class=hljs-annotation>@Test</span>
  <span class=hljs-function><span class=hljs-keyword>public</span> <span class=hljs-keyword>void</span> <span class=hljs-title>test</span><span class=hljs-params>(TestContext context)</span> </span>{
    Async async = context.async();
    vertx.createHttpClient().get(<span class=hljs-number>8080</span>, <span class=hljs-string>"localhost"</span>, <span class=hljs-string>"/"</span>)
      .handler(response -&gt; {
        context.assertEquals(<span class=hljs-number>200</span>, response.statusCode());
        response.bodyHandler(buffer -&gt; {
          context.assertEquals(<span class=hljs-string>"hello vert.x"</span>, buffer.toString(<span class=hljs-string>"utf-8"</span>));
          async.complete();
        });
      })
      .end();
  }
}</code></pre><p>First, the test class is annotated with <code>@RunWith(VertxUnitRunner.class)</code>, instructing JUnit to use this special runner. This runner lets you inject a <code>TestContext</code> parameter into every test methods (as well as <code>@Before</code> and <code>@After</code>) to handle the asynchronous aspect of the test.</p><p>In the <code>setUp</code> method, it creates a new instance of <code>Vertx</code> and deploy the verticle. Thanks to <code>context.asyncAssertSuccess()</code>, it waits until the successful completion of the verticle deployment. Indeed, the deployment is asynchronous, and we must be sure that the verticle has been deployed and has completed its initialization before starting to test it.</p><p>The <code>test()</code> method creates an <code>Async</code> object that will be used to report when the test has been completed. Then it creates an HTTP client to emit a request on the server from our verticle and check that:</p><ol><li>the HTTP code is <code>200 (OK)</code></li><li>the body is <code>hello vert.x</code></li></ol><p>As you can see, to implement the checks, the assertions method are called on the <code>TestContext</code> object, which control the test execution. When everything has been tested, we call <code>async.complete()</code> to end the test. If an assertion failed, the test is obviously stopped. This would not be the case if you would use regular Junit assertions.</p><h2 id=using-the-hamcrest-matchers>Using the Hamcrest Matchers</h2><p>In the previous example, we used the the assertions available from the <code>TestContext</code> instance. However it provides a limited set of methods. Hamcrest is a library of matchers, which can be combined in to create flexible expressions of intent in tests. It is very convenient when testing complex applications.</p><p>Hamcrest cannot be used directly as it would not report the failure on the <code>TestContext</code>. For this purpose we create a <code>VertxMatcherAssert</code> class:</p><pre><code class="hljs java"><span class=hljs-keyword>public</span> <span class=hljs-class><span class=hljs-keyword>class</span> <span class=hljs-title>VertxMatcherAssert</span> </span>{

  <span class=hljs-keyword>public</span> <span class=hljs-keyword>static</span> &lt;T&gt; <span class=hljs-function><span class=hljs-keyword>void</span> <span class=hljs-title>assertThat</span><span class=hljs-params>(TestContext context, T actual,
    Matcher&lt;? <span class=hljs-keyword>super</span> T&gt; matcher)</span> </span>{
    assertThat(context, <span class=hljs-string>""</span>, actual, matcher);
  }

  <span class=hljs-keyword>public</span> <span class=hljs-keyword>static</span> &lt;T&gt; <span class=hljs-function><span class=hljs-keyword>void</span> <span class=hljs-title>assertThat</span><span class=hljs-params>(TestContext context, String reason,
    T actual, Matcher&lt;? <span class=hljs-keyword>super</span> T&gt; matcher)</span> </span>{
    <span class=hljs-keyword>if</span> (!matcher.matches(actual)) {
      Description description = <span class=hljs-keyword>new</span> StringDescription();
      description.appendText(reason)
          .appendText(<span class=hljs-string>"\nExpected: "</span>)
          .appendDescriptionOf(matcher)
          .appendText(<span class=hljs-string>"\n     but: "</span>);
      matcher.describeMismatch(actual, description);
      context.fail(description.toString());
    }
  }

  <span class=hljs-function><span class=hljs-keyword>public</span> <span class=hljs-keyword>static</span> <span class=hljs-keyword>void</span> <span class=hljs-title>assertThat</span><span class=hljs-params>(TestContext context, String reason,
    <span class=hljs-keyword>boolean</span> assertion)</span> </span>{
    <span class=hljs-keyword>if</span> (!assertion) {
      context.fail(reason);
    }
  }
}</code></pre><p>This class provides <code>assertThat</code> method that reports error on the given <code>TestContext</code>. The complete code is available <a href=https://gist.github.com/cescoffier/5cbf4c69aa094ac9b1a6>here</a>.</p><p>With this class, we can re-implement our test as follows:</p><pre><code class="hljs java"><span class=hljs-annotation>@Test</span>
<span class=hljs-function><span class=hljs-keyword>public</span> <span class=hljs-keyword>void</span> <span class=hljs-title>testWithHamcrest</span><span class=hljs-params>(TestContext context)</span> </span>{
  Async async = context.async();
  vertx.createHttpClient().get(<span class=hljs-number>8080</span>, <span class=hljs-string>"localhost"</span>, <span class=hljs-string>"/"</span>).handler(response -&gt; {
    assertThat(context, response.statusCode(), is(<span class=hljs-number>200</span>));
    response.bodyHandler(buffer -&gt; {
      assertThat(context, buffer.toString(<span class=hljs-string>"utf-8"</span>), is(<span class=hljs-string>"hello vert.x"</span>));
      async.complete();
    });
  }).end();
}</code></pre><p>To ease the usage, I’ve added two <em>import static</em>:</p><pre><code class="hljs java"><span class=hljs-keyword>import</span> <span class=hljs-keyword>static</span> io.vertx.unit.example.VertxMatcherAssert.assertThat;
<span class=hljs-keyword>import</span> <span class=hljs-keyword>static</span> org.hamcrest.core.Is.is;</code></pre><p>You can use any Hamcrest matcher, or even implement your own as soon as you use the <code>assertThat</code> method provided by <code>VertxMatcherAssert</code>.</p><h2 id=conclusion>Conclusion</h2><p>In this post we have seen how you can combine Hamcrest and Vert.x Unit. So, you are not limited anymore by the set of assert methods provided by Vert.x Unit, and can use the whole expressiveness of Hamcrest Matchers.</p><p>Don’t forget that you still can’t use the <code>assert</code> methods from Junit, as they don’t report on the <code>TestContext</code>.</p></article></article></div><div class=row><div class=col-xs-12 id=disqus_thread></div></div><script type=text/javascript>/* * * CONFIGURATION VARIABLES * * */
  var disqus_shortname = 'vertx';

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></div><footer><div class=container><div class=row><div class="col-xs-6 col-sm-3 col-md-3 col-lg-2"><h2>Vert.x</h2><ul class=list-unstyled><li><a href="http://vertx.io/">Home</a></li><li><a href="http://vertx.io/download/">Download</a></li><li><a href="http://vertx.io/docs/">Documentation</a></li><li><a href=https://github.com/vert-x3/wiki/wiki>Wiki</a></li><li><a href="http://vertx.io/blog/">Blog</a></li><li><a href="http://vertx.io/vertx2/" class=vertx-2-link>Vert.x 2</a></li></ul></div><div class="col-xs-6 col-sm-3 col-md-3 col-lg-2"><h2>Community</h2><ul class=list-unstyled><li><a href="http://vertx.io/community/">Help &amp; Contributors</a></li><li><a href="http://vertx.io/materials/">Learning materials</a></li><li><a href=https://groups.google.com/forum/?fromgroups#!forum/vertx>User Group</a></li><li><a href=https://groups.google.com/forum/?fromgroups#!forum/vertx-dev>Developer Group</a></li></ul></div><div class="col-xs-12 col-sm-6 col-lg-offset-2 col-md-6 copyright"><p>Vert.x is open source and dual licensed under the <a href=https://www.eclipse.org/org/documents/epl-v10.php>Eclipse Public License 1.0</a> and <a href=https://www.apache.org/licenses/LICENSE-2.0.html>Apache License 2.0</a>.</p><p>This website is licensed under the <a href="http://creativecommons.org/licenses/by-sa/3.0/">CC BY-SA 3.0 License</a>.<br>Design by <a href=http://www.michel-kraemer.com>Michel Kr&auml;mer</a>. <a href=http://www.entypo.com>Entypo pictograms</a> by Daniel Bruce.</p><div class=row><div class="col-xs-12 col-lg-offset-2 col-md-5"><img class="logo eclipse-logo" src=http://vertx.io/assets/eclipse_logo_grey_small.png width=204 height=48></div><div class="col-xs-12 col-md-offset-2 col-lg-offset-0 col-md-5"><img class="logo cloudbees-logo" src=http://vertx.io/assets/Button-Built-on-CB-1-grey.png width=184 height=48></div></div></div></div></div></footer><script src=http://static.jboss.org/theme/js/libs/jquery/jquery-1.9.1.min.js></script><script src=http://vertx.io/javascripts/bootstrap.min.js></script><script src=http://vertx.io/javascripts/highlight.pack.js></script><script>hljs.initHighlightingOnLoad();</script></body></html>